# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Orbs are reusable packages of CircleCI configuration that you may share across projects, enabling you to create encapsulated, parameterized commands, jobs, and executors that can be used across multiple projects.
# See: https://circleci.com/docs/2.0/orb-intro/
orbs:
    python: circleci/python@1.2

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
    build_format_test:
        # A list of available CircleCI Docker convenience images are available here: https://circleci.com/developer/images/image/cimg/python
        docker:
            - image: cimg/python:3.10.0
        # Checkout the code as the first step. This is a dedicated CircleCI step.
        steps:
            - checkout
            - python/install-packages:
                pkg-manager: pip
                # app-dir: ~/project/package-directory/  # If your requirements.txt isn't in the root directory.
                pip-dependency-file: requirements_dev.txt # if you have a different name for your requirements file, maybe one that combines your runtime and test requirements.
            # Format
            - run: echo "Checking formatting ..."
            - run: black --check .
            - run: isort --check .
            # Build
            - run: echo "Building ..."
            - run: python --version
            # Test
            - run: echo "Testing toy problems ..."
            - run: pytest --cov $(pwd)/implementations/ --cov-branch $(pwd)/implementations/ --cov-report term-missing --cov-fail-under 100
            # Test
            - run: echo "Testing markdown parser..."
            - run: pytest --cov $(pwd)/markdown-parser/ --cov-branch $(pwd)/markdown-parser/ --cov-report term-missing --cov-fail-under 80

# Invoke jobs via workflows
workflows:
    build_and_test:
        jobs:
            - build_format_test
